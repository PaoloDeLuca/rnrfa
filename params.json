{"name":"RNRFA","tagline":"UK National River Flow Archive data from R","body":"RNRFA: an R package to interact with the UK National River Flow Archive\r\n=======\r\n\r\n[![DOI](https://zenodo.org/badge/doi/10.5281/zenodo.14722.svg)](http://dx.doi.org/10.5281/zenodo.14722)\r\n\r\nThe UK National River Flow Archive serves daily streamflow data, spatial rainfall averages and information regarding elevation, geology, land cover and FEH related catchment descriptors.\r\n\r\nThere is currently an API under development that in future should provide access to the following services: metadata catalogue, catalogue filters based on a geographical bounding-box, catalogue filters based on metadata entries, gauged daily data for about 400 stations available in WaterML2 format, the OGC standard used to describe hydrological time series.  \r\n\r\nThe information returned by the first three services is in JSON format, while the last one is an XML variant.\r\n\r\nThe RNRFA package aims to achieve a simpler and more efficient access to data by providing wrapper functions to send HTTP requests and interpret XML/JSON responses. \r\n\r\n**To cite this software:**  \r\nVitolo C. and Fry M., R interface for the National River Flow Archive (rnrfa, R package), (2014), GitHub repository, https://github.com/cvitolo/r_rnrfa, doi: http://dx.doi.org/10.5281/zenodo.14722\r\n\r\n\r\n# Dependencies\r\nThe rnrfa package is dependent on a number of CRAN packages. Install them first:\r\n\r\n```R\r\ninstall.packages(c(\"XML2R\", \"RCurl\", \"zoo\", \"rjson\", \"rgdal\", \"sp\", \"stringr\"))\r\n```\r\n\r\nThis demo makes also use of external libraries. To install and load them run the following commands:\r\n\r\n```R\r\npacks <- c(\"devtools\", \"parallel\", \"ggplot2\", \"DT\", \"leaflet\", \"dygraphs\")\r\ninstall.packages(packs)\r\nlapply(packs, require, character.only = TRUE)\r\n```\r\n\r\n\r\n# Installation\r\nThe stable version (preferred option) of rnrfa is available from CRAN using `install.packages(\"rnrfa\")`, while the development version is available on github via devtools:\r\n\r\n```R\r\ninstall_github(\"cvitolo/r_rnrfa\", subdir = \"rnrfa\")\r\n```\r\n\r\nNow, load the rnrfa package:\r\n\r\n```R\r\nlibrary(rnrfa)\r\n```\r\n\r\n# Functions\r\n\r\n## List of monitoring stations\r\nThe R function that deals with the NRFA catalogue to retrieve the full list of monitoring stations is called catalogue(). The function, used with no inputs, requests the full list of gauging stations with associated metadata. The output is a dataframe containing one record for each station and as many columns as the number of metadata entries available. \r\n\r\n```R\r\n# Retrieve information for all the stations in the catalogue:\r\nallStations <- catalogue()\r\n```\r\n\r\nThose entries are briefly described as follows:\r\n* \"id\" = Station identification number\r\n* \"name\" = Name of the station\r\n* \"location\" = Area in which the station is located\r\n* \"river\" = River catchment\r\n* \"stationDescription\" = General station description, containing information on weirs, ratings, etc.\r\n* \"catchmentDescription\" = Information on topography, geology, land cover, etc.\r\n* \"hydrometricArea\" = UK hydrometric area identification number\r\n* \"operator\" = UK measuring authorities\r\n* \"haName\" = Hydrometric Area name\r\n* \"gridReference\" = OS Grid Reference number\r\n* \"stationType\" = Type of station (e.g. flume, weir, etc.)\r\n* \"catchmentArea\" = Catchment area in (Km^2)\r\n* \"gdfStart\" = Year in which recordings started\r\n* \"gdfEnd\" = Year in which recordings ended\r\n* \"farText\" = Information on the regime (e.g. natural, regulated, etc.)\r\n* \"categories\" = various tags (e.g. FEH\\_POOLING, FEH\\_QMED, HIFLOWS\\_INCLUDED)\r\n* \"altitude\" = Altitude measured in metres above Ordnance Datum or, in Northern Ireland, Malin Head.\r\n* \"sensitivity\" = Sensitivity index calculated as the percentage change in flow associated with a 10 mm increase in stage at the $Q_{95}$ flow.\r\n* \"lat\" = a numeric vector of latitude coordinates.\r\n* \"lon\" = a numeric vector of longitude coordinates.\r\n\r\n## Station filtering\r\nThe same function catalogue() can be used to filter stations based on a bounding box or any of the metadata entries. \r\n\r\n```R\r\n# Define a bounding box:\r\nbbox <- list(lonMin=-3.82, lonMax=-3.63, latMin=52.43, latMax=52.52)\r\n\r\n# Filter stations based on bounding box\r\nsomeStations <- catalogue(bbox)\r\n                                  \r\n# Filter stations belonging to a certain hydrometric area\r\nsomeStations <- catalogue(metadataColumn=\"haName\", entryValue=\"Wye (Hereford)\")\r\n\r\n# Filter based on bounding box & metadata strings\r\nsomeStations <- catalogue(bbox,\r\n                          metadataColumn=\"haName\",\r\n                          entryValue=\"Wye (Hereford)\")\r\n\r\n# Filter stations based on threshold\r\nsomeStations <- catalogue(bbox,\r\n                          metadataColumn=\"catchmentArea\",\r\n                          entryValue=\">1\")\r\n\r\n# Filter based on minimum recording years\r\nsomeStations <- catalogue(bbox,\r\n                          metadataColumn=\"catchmentArea\",\r\n                          entryValue=\">1\",\r\n                          minRec=30)\r\n                                  \r\n# Filter stations based on identification number\r\nsomeStations <- catalogue(metadataColumn=\"id\",\r\n                          entryValue=c(3001,3002,3003))\r\n                               \r\n# Other combined filtering\r\nsomeStations <- catalogue(bbox,\r\n                          metadataColumn=\"id\",\r\n                          entryValue=c(54022,54090,54091,54092,54097),\r\n                          minRec=35)\r\n```\r\n\r\n## Conversions\r\nThe only geospatial information contained in the list of station in the catalogue is the OS grid reference (column \"gridRef\"). The RNRFA package allows convenient conversion to more standard coordinate systems. The function \"OSGParse()\", for example, converts the string to easting and northing in the BNG coordinate system (EPSG code: 27700), as in the example below:\r\n\r\n```R\r\n# Where is the first catchment located?\r\nsomeStations$gridReference[[1]]\r\n\r\n# Convert OS Grid reference to BNG\r\nOSGparse(\"SN853872\")\r\n```\r\n\r\nThe same function can also convert from BNG to latitude and longitude in the WSGS84 coordinate system (EPSG code: 4326) as in the example below.\r\n\r\n```R\r\n# Convert BNG to WSGS84\r\nOSGparse(\"SN853872\", CoordSystem = \"WGS84\")\r\n```\r\n\r\n## Get station time series data and metadata \r\nThe station's id number can be used to retrieve the streamflow time series converting the waterml2 file to a time series object (zoo).\r\n\r\n```R\r\n# Choose a station by its id number\r\nstationID <- 3001\r\n \r\n# Get time series data from the waterml2 service (flow)\r\ndata <- GDF(stationID)\r\n\r\n# Get time series data from the waterml2 service (rainfall)\r\ndataR <- CMR(stationID)\r\n\r\n# Get time series metadata from the waterml2 service\r\nmetadata <- GDFmeta(stationID)\r\n```\r\n\r\nThe time series can be plotted as shown below.\r\n\r\n```R\r\n# Plot streamflow timeseries data\r\nlibrary(zoo)\r\nplot(data, main = metadata$stationName)\r\n```\r\n\r\n## Multiple sites\r\nRetrieving information for multiple sites becomes trivial:\r\n\r\n```R \r\n# Search data/metadata in the waterml2 service\r\ns <- GDF(c(3001,3002,3003))\r\n\r\n# s is a list of 3 object (one object for each site)\r\nfirstSite  <- s[[1]]  # s$ID3001\r\nsecondSite <- s[[2]]  # s$ID3002\r\nthirdSite  <- s[[3]]  # s$ID3003\r\n\r\nplot(secondSite,col=\"blue\")\r\nlines(thirdSite,col=\"green\")\r\n```\r\n\r\n# INTEROPERABILITY\r\n\r\n## Create interactive maps using leaflet:\r\n\r\n```R \r\nlibrary(leaflet)\r\n\r\nleaflet(data = someStations) %>% addTiles() %>%\r\n  addMarkers(~lon, ~lat, popup = ~paste(id,name))\r\n```\r\n\r\n## Interactive plots using dygraphs:\r\n\r\n```R \r\nlibrary(dygraphs)\r\ndygraph(data) %>% dyRangeSelector()\r\n```\r\n\r\n## Parallel processing:\r\n\r\nA simple benchmark test\r\n```R \r\nlibrary(parallel)\r\ndetectCores()   #             How many cores are available on the local machine?\r\n# 8\r\n\r\nsystem.time( s1 <- GDF(someStations$id) )\r\n#   user  system elapsed \r\n# 46.368   0.080  48.240\r\n\r\nsystem.time( s2 <- mclapply(someStations$id, GDF, mc.cores = detectCores()) )\r\n#   user  system elapsed \r\n# 24.976   0.192  26.272\r\n```\r\n\r\nMake time consuming tasks faster\r\n```R\r\n# Use all the stations operated by the Natural Resources Wales\r\nstations <- catalogue(metadataColumn=\"operator\", \r\n                          entryValue=\"Natural Resources Wales\")\r\n\r\n# Get the time series (TS)\r\nTS <- mclapply(stations$id, GDF, mc.cores = detectCores())    # parallel package\r\nstations$meanGDF <- unlist( lapply(TS, mean) )   \r\n\r\n# Linear model\r\nlibrary(ggplot2)\r\nggplot(stations, aes(x = as.numeric(catchmentArea), y = meanGDF)) + \r\n  geom_point() +\r\n  stat_smooth(method = \"lm\", col = \"red\") +\r\n  xlab(expression(paste(\"Catchment area [Km^2]\",sep=\"\"))) + \r\n  ylab(expression(paste(\"Mean flow [m^3/s]\",sep=\"\")))\r\n```\r\n\r\n# Terms and Conditions\r\nPlease refer to the following Terms and Conditions for use of NRFA Data and disclaimer: http://nrfa.ceh.ac.uk/costs-terms-and-conditions\r\n\r\nThis package uses a non-public API which is likely to change. Package and functions herein are provided as is, without any guarantee.\r\n\r\n# Leave your feedback\r\nI would greatly appreciate if you could leave your feedbacks either via email (cvitolodev@gmail.com) or taking a short survey (https://www.surveymonkey.com/s/GTGH8RX).\r\n","google":"UA-44379190-3","note":"Don't delete this file! It's used internally to help with page regeneration."}